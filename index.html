<!DOCTYPE html>
<html>
<head>
  <title>Math Battle PvP</title>
</head>
<body>

<h2>Math Battle - Player vs Player</h2>

<button onclick="createRoom()">Create Room</button>
<input id="roomInput" placeholder="Enter Room Code">
<button onclick="joinRoom()">Join Room</button>

<h3 id="roomCodeDisplay"></h3>
<h3 id="question"></h3>

<div id="options"></div>

<h3 id="scoreBoard"></h3>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { getDatabase, ref, set, update, get, onValue } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyDyvQ6dEJ5ePgfOSWT4cKkUsQJiJBDarUA",
  authDomain: "de-quizz.firebaseapp.com",
  projectId: "de-quizz",
  storageBucket: "de-quizz.firebasestorage.app",
  messagingSenderId: "655485330786",
  appId: "1:655485330786:web:95e01bf8dd5fd88cb0f83b"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

let playerId = null;
let roomCode = null;

signInAnonymously(auth).then((userCred) => {
  playerId = userCred.user.uid;
  console.log("Logged in:", playerId);
});

function generateRoomCode() {
  return Math.floor(10000 + Math.random() * 90000).toString();
}

window.createRoom = async function() {
  roomCode = generateRoomCode();

  await set(ref(db, "rooms/" + roomCode), {
    players: {
      host: { score: 0 }
    },
    currentQuestion: 0,
    questionState: { locked: false },
    question: generateQuestion()
  });

  document.getElementById("roomCodeDisplay").innerText = "Room Code: " + roomCode;
  listenRoom();
}

window.joinRoom = async function() {
  roomCode = document.getElementById("roomInput").value;

  await update(ref(db, "rooms/" + roomCode + "/players"), {
    guest: { score: 0 }
  });

  listenRoom();
}

function generateQuestion() {
  let a = Math.floor(Math.random() * 10) + 1;
  let b = Math.floor(Math.random() * 10) + 1;
  let correct = a + b;

  let options = [
    correct,
    correct + 1,
    correct - 1,
    correct + 2
  ].sort(() => Math.random() - 0.5);

  return {
    text: `${a} + ${b}`,
    correct: correct,
    options: options
  };
}

function listenRoom() {
  onValue(ref(db, "rooms/" + roomCode), (snapshot) => {
    const data = snapshot.val();
    if (!data) return;

    displayQuestion(data.question);
    displayScores(data.players);
  });
}

function displayQuestion(q) {
  document.getElementById("question").innerText = q.text;

  const optionsDiv = document.getElementById("options");
  optionsDiv.innerHTML = "";

  q.options.forEach(option => {
    let btn = document.createElement("button");
    btn.innerText = option;
    btn.onclick = () => answer(option);
    optionsDiv.appendChild(btn);
  });
}

async function answer(selected) {
  const roomRef = ref(db, "rooms/" + roomCode);
  const snapshot = await get(roomRef);
  const data = snapshot.val();

  if (data.questionState.locked) return;

  let role = data.players.host ? "host" : "guest";
  let correct = data.question.correct;

  if (selected === correct) {
    await update(roomRef, {
      [`players/host/score`]: (data.players.host?.score || 0) + 2,
      questionState: { locked: true }
    });
  } else {
    await update(roomRef, {
      [`players/host/score`]: (data.players.host?.score || 0) - 1
    });
  }
}

function displayScores(players) {
  let text = "";
  for (let p in players) {
    text += p + ": " + players[p].score + " | ";
  }
  document.getElementById("scoreBoard").innerText = text;
}

</script>

</body>
</html>
